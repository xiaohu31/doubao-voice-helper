# 豆包语音输入助手

一个 Windows 便携式辅助工具,让豆包桌面版的语音输入功能更加自动化、流畅。

## ✨ 功能特性

### 两种输入模式（同时可用）

| 模式 | 操作方式 | 适用场景 | 默认按键 |
|------|----------|----------|----------|
| **按着说** | 按住按键 → 说话 → 松开自动插入 | 快速短句输入 | 鼠标侧键2 (XButton2) |
| **自由说** | 点一下开始 → 说话 → 再点一下结束并插入 | 长段落输入 | 鼠标侧键1 (XButton1) |

### 核心功能

- ✅ **剪贴板保护**：不覆盖用户原有剪贴板内容
- ✅ **智能检测**：自动检测是否说话,无内容快速关闭
- ✅ **防抖保护**：防止长按导致重复触发
- ✅ **失焦处理**：自动激活豆包悬浮窗,确保按键有效
- ✅ **可配置按键**：支持键盘单键、组合键、鼠标侧键/中键

## 📋 使用前提

1. 已安装豆包桌面版
2. 豆包语音输入功能正常可用
3. 豆包快捷键已配置（默认 Ctrl+D）

## 🚀 快速开始

### 方式一：直接运行脚本

需要先安装 [AutoHotkey v2](https://www.autohotkey.com/download/)

1. 双击 `src/main.ahk` 运行

### 方式二：运行编译后的 exe

1. 双击 `dist/豆包语音助手.exe`

## ⚙️ 配置说明

双击托盘图标或右键选择"设置"打开配置界面。

### 基本配置

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| 按着说触发键 | 按住说话的触发按键 | 鼠标侧键2 (XButton2) |
| 自由说触发键 | 点击切换说话的触发按键 | 鼠标侧键1 (XButton1) |
| 豆包快捷键 | 唤起豆包语音的快捷键 | Ctrl+D |
| 识别延迟 | 松开后等待豆包识别完成的时间 | 595ms |
| 剪贴板保护 | 是否保护原有剪贴板内容 | 开启 |
| 开机自启动 | 是否随系统启动 | 关闭 |

### 高级配置

| 配置项 | 说明 | 默认值 | 推荐范围 |
|--------|------|--------|----------|
| 剪贴板超时 | 等待剪贴板变化的超时时间 | 150ms | 100-200ms |

**配置说明**：
- **识别延迟**：松开后等待豆包识别完成的时间,太短可能识别不完整。默认 595ms
- **剪贴板超时**：等待豆包写入剪贴板的时间,超时则认为用户没说话。默认 150ms,范围 100-200ms

### 支持的触发按键

- **鼠标按键**：侧键1 (XButton1)、侧键2 (XButton2)、中键 (MButton)
- **功能键**：F1-F12
- **字母键**：A-Z
- **数字键**：0-9
- **特殊键**：CapsLock、右Ctrl、右Alt、右Shift
- **组合键**：Ctrl+字母、Alt+字母、Win+字母等

## 🔧 工作原理

```
用户按下触发键
    ↓
记录当前焦点窗口
    ↓
发送 Ctrl+D 唤起豆包语音（悬浮窗弹出）
    ↓
用户说话...（豆包实时转写）
    ↓
用户松开触发键（按着说）/ 再次按下触发键（自由说）
    ↓
提前检测悬浮窗内容（HasVoiceContent）
    ├─ 无内容 → 发送 ESC 快速关闭 (~50ms)
    └─ 有内容 → 继续流程
        ↓
    等待识别延迟 (595ms)
        ↓
    备份剪贴板
        ↓
    激活豆包悬浮窗 + 发送 Enter（解决失焦问题）
        ↓
    轮询检测剪贴板变化 (150ms 超时)
        ↓
    ┌─ 检测到变化 → 等待粘贴完成 → 恢复原剪贴板
    └─ 超时未变化 → 发送 ESC 关闭悬浮窗
```

**关键特性**：
- 豆包会将内容插入到**当前焦点窗口**的光标位置
- 说话过程中切换窗口,内容会插入到新窗口
- 发送按键前会自动激活豆包悬浮窗,解决失焦问题
- 提前检测无内容,快速关闭悬浮窗（745ms → 50ms）
- 自由说按键防抖保护,防止长按重复触发

## ❓ 常见问题

### Q: 为什么识别结果没有插入？

1. 检查豆包是否正常运行
2. 检查豆包快捷键是否正确（默认 Ctrl+D）
3. 尝试增加"识别延迟"设置

### Q: 长按自由说按键会一直提示怎么办？

已修复！v4.4 版本添加了防抖保护,长按不会重复触发。

### Q: 如何更改触发按键？

双击托盘图标打开设置,选择新的触发按键或点击"录制"按钮录制按键。

### Q: 修改配置后功能失效怎么办？

如果修改配置保存后功能失效,请尝试：
1. 重启程序（右键托盘图标 → 退出 → 重新运行）
2. 检查是否有热键冲突（托盘会提示）
3. 查看 [问题解决记录](docs/problem-solving-log.md) 了解已知问题

## 📝 更新日志

### 2026-01-18 (v4.4.1)
- ✅ 新增：单文件 EXE 打包支持（无需外部依赖）
- ✅ 新增：自定义 EXE 图标
- ✅ 优化：配置文件自动保存到用户目录 `%AppData%\DouBaoVoiceHelper\`
- ✅ 优化：托盘图标支持系统内置图标作为后备

### 2026-01-18 (v4.4)
- ✅ 修复：自由说按键长按导致重复提示的问题
- ✅ 新增：自由说按键防抖保护（500ms 间隔）
- ✅ 新增：托盘提示去重保护（2秒内不重复）
- 🎯 优化：用户体验显著提升

### 2026-01-18 (v4.3)
- ✅ 移除：MinHoldDuration 参数（提前检测已覆盖其功能）
- ✅ 优化：ClipboardTimeout 范围（100-200ms）
- ✅ 简化：配置项,提升用户体验
- 🎨 优化：GUI 界面更简洁

### 2026-01-18 (v4.2)
- ✅ 新增：自由说模式提前检测无内容,快速关闭（745ms → 50ms）
- ✅ 新增：自由说模式结束时检测窗口是否存在
- ✅ 新增：自由说模式启动后延迟检测悬浮窗是否弹出
- ✅ 新增：`DoubaoWindow.HasVoiceContent()` 方法
- ✅ 优化：ClipboardTimeout 默认值（500ms → 150ms）

### 2026-01-18 (v4.1)
- ✅ 增强：重复触发保护（处理中忽略新触发）
- ✅ 增强：豆包崩溃保护（检测运行状态）
- ✅ 优化：超时时间保护（最小值 100ms）
- ✅ 优化：SendKey 窗口检查（避免误发送）
- 📝 新增：[极端情况分析文档](docs/edge-cases-analysis.md)

### 2026-01-18 (v4.0)
- ✅ 新增：失焦场景处理,发送按键前自动激活豆包悬浮窗
- ✅ 新增：豆包窗口管理模块 (doubao.ahk)
- ✅ 新增：窗口调研工具 (tools/window-spy.ahk)
- ✅ 修复：快速按一下时豆包悬浮窗不关闭的问题
- ✅ 修复：剪贴板恢复时序问题导致粘贴错误内容
- ✅ 修复：配置保存后功能失效的问题（热键槽位占用）
- 📝 添加：完整的流程图文��
- 📝 添加：问题解决记录文档

## 📁 文件结构

```
DouBaoVoiceHelper/
├── src/
│   ├── main.ahk           # 主程序入口
│   ├── config.ahk         # 配置管理
│   ├── hotkey.ahk         # 热键监听（含防抖保护）
│   ├── clipboard.ahk      # 剪贴板操作
│   ├── window.ahk         # 窗口焦点管理
│   ├── gui.ahk            # GUI 界面
│   └── doubao.ahk         # 豆包窗口管理
├── tools/
│   └── window-spy.ahk     # 窗口调研工具
├── assets/
│   └── icon.ico           # 托盘图标（可选）
├── dist/
│   └── 豆包语音助手.exe    # 编译后的可执行文件
├── config.ini             # 用户配置文件
└── README.md              # 使用说明
```

## 🛠️ 技术栈

- AutoHotkey v2
- 无外部依赖

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📄 许可证

MIT License

## 🙏 致谢

感谢豆包团队提供优秀的语音识别功能。
