# 豆包语音助手

一个 Windows 便携式辅助工具，让豆包桌面版的语音输入功能更加自动化、流畅。

## 功能特性

### 两种输入模式（同时可用）

| 模式 | 操作方式 | 适用场景 | 默认按键 |
|------|----------|----------|----------|
| **按着说** | 按住按键 → 说话 → 松开自动插入 | 快速短句输入 | 鼠标侧键1 |
| **自由说** | 点一下开始 → 说话 → 再点一下结束并插入 | 长段落输入 | 鼠标侧键2 |

### 其他功能

- **剪贴板保护**：不覆盖用户原有剪贴板内容
- **焦点恢复**：自动切回原窗口，失败则托盘提示
- **可配置按键**：支持键盘单键、组合键、鼠标侧键/中键

## 使用前提

1. 已安装豆包桌面版
2. 豆包语音输入功能正常可用
3. 豆包快捷键已配置（默认 Ctrl+D）

## 使用方法

### 方式一：直接运行脚本

需要先安装 [AutoHotkey v2](https://www.autohotkey.com/download/)

1. 双击 `src/main.ahk` 运行

### 方式二：运行编译后的 exe

1. 双击 `dist/豆包语音助手.exe`

## 配置说明

双击托盘图标或右键选择"设置"打开配置界面。

### 基本配置

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| 按着说触发键 | 按住说话的触发按键 | 鼠标侧键1 (XButton1) |
| 自由说触发键 | 点击切换说话的触发按键 | 鼠标侧键2 (XButton2) |
| 豆包快捷键 | 唤起豆包语音的快捷键 | Ctrl+D |
| 识别延迟 | 松开后等待豆包识别完成的时间 | 1500ms |
| 剪贴板保护 | 是否保护原有剪贴板内容 | 开启 |
| 开机自启动 | 是否随系统启动 | 关闭 |

### 高级配置

| 配置项 | 说明 | 默认值 | 推荐范围 |
|--------|------|--------|----------|
| 焦点恢复 | 是否自动恢复窗口焦点 | 开启 | - |
| 托盘提示 | 是否显示托盘通知 | 开启 | - |
| 剪贴板超时 | 等待剪贴板变化的超时时间 | 500ms | 100-2000ms |
| 最小按住时长 | 按着说模式的最短按住时间 | 300ms | 200-1500ms |

**配置说明**：
- **剪贴板超时**：发送回车后等待豆包写入剪贴板的时间，超时则认为用户没说话
- **最小按住时长**：按住时间小于此值会自动取消，避免误触

### 支持的触发按键

- **鼠标按键**：侧键1、侧键2、中键
- **功能键**：F1-F12
- **特殊键**：CapsLock、右Ctrl、右Alt

## 工作原理

```
用户按下触发键
    ↓
记录当前焦点窗口
    ↓
发送 Ctrl+D 唤起豆包语音（悬浮窗弹出）
    ↓
用户说话...（豆包实时转写）
    ↓
用户松开触发键（按着说）/ 再次按下触发键（自由说）
    ↓
等待识别延迟
    ↓
备份剪贴板
    ↓
激活豆包悬浮窗 + 发送 Enter（解决失焦问题）
    ↓
轮询检测剪贴板变化
    ↓
┌─ 检测到变化 → 等待粘贴完成 → 恢复原剪贴板
└─ 超时未变化 → 发送 ESC 关闭悬浮窗 → 提示用户
```

**关键特性**：
- 豆包会将内容插入到**当前焦点窗口**的光标位置
- 说话过程中切换窗口，内容会插入到新窗口
- 发送按键前会自动激活豆包悬浮窗，解决失焦问题

## 常见问题

### Q: 为什么识别结果没有插入？

1. 检查豆包是否正常运行
2. 检查豆包快捷键是否正确
3. 尝试增加"插入延迟"设置

### Q: 焦点丢失怎么办？

如果托盘提示"焦点丢失"，识别内容已复制到剪贴板，可手动 Ctrl+V 粘贴。

### Q: 如何更改触发按键？

双击托盘图标打开设置，选择新的触发按键或点击"录制"按钮录制按键。

### Q: 修改配置后功能失效怎么办？

如果修改配置保存后功能失效，请尝试：
1. 重启程序（右键托盘图标 → 退出 → 重新运行）
2. 检查是否有热键冲突（托盘会提示）
3. 查看 [问题解决记录](docs/problem-solving-log.md) 了解已知问题

## 更新日志

### 2026-01-18 (v1.2)
- ✅ 新增：托盘图标状态变化（正常/禁用/处理中）
- ✅ 新增：托盘菜单显示当前热键配置
- ✅ 新增：关于对话框
- 🎨 优化：托盘菜单使用系统图标（无需额外图标文件）

### 2026-01-18 (v1.1)
- ✅ 新增：失焦场景处理，发送按键前自动激活豆包悬浮窗
- ✅ 新增：豆包窗口管理模块 (doubao.ahk)
- ✅ 新增：窗口调研工具 (tools/window-spy.ahk)
- ✅ 修复：快速按一下时豆包悬浮窗不关闭的问题
- ✅ 修复：剪贴板恢复时序问题导致粘贴错误内容
- ✅ 修复：配置保存后功能失效的问题（热键槽位占用）
- 📝 更新：完善帮助信息，添加配置说明和常见问题
- 📝 更新：完善 README 配置项说明
- 📝 添加：完整的流程图文档
- 📝 添加：问题解决记录文档
- 📝 添加：下一步开发计划

## 文档

- [完整流程图](docs/flow-diagram.md) - 按着说和自由说模式的详细流程
- [问题解决记录](docs/problem-solving-log.md) - 已知问题和解决方案
- [下一步计划](docs/next-steps-plan.md) - 开发计划和进度

## 文件结构

```
DouBaoVoiceHelper/
├── src/
│   ├── main.ahk           # 主程序入口
│   ├── config.ahk         # 配置管理
│   ├── hotkey.ahk         # 热键监听
│   ├── clipboard.ahk      # 剪贴板操作
│   ├── window.ahk         # 窗口焦点管理
│   ├── gui.ahk            # GUI 界面
│   └── doubao.ahk         # 豆包窗口管理（新增）
├── tools/
│   └── window-spy.ahk     # 窗口调研工具（新增）
├── docs/
│   ├── flow-diagram.md    # 完整流程图
│   ├── problem-solving-log.md  # 问题解决记录
│   └── next-steps-plan.md # 下一步计划
├── assets/
│   └── icon.ico           # 托盘图标（可选）
├── dist/
│   └── 豆包语音助手.exe    # 编译后的可执行文件
├── config.ini             # 用户配置文件
└── README.md              # 使用说明
```

## 技术栈

- AutoHotkey v2
- 无外部依赖

## 许可证

MIT License
